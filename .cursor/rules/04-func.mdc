---
description: 비즈니스 로직, 폼 처리, API 통신, 테스트(Playwright) 구현 규칙
globs: src/app/**/*.tsx, src/components/**/*.tsx, src/hooks/**/*.ts, src/lib/**/*.ts
alwaysApply: true
---

아래의 조건 및 주의사항을 모두 적용하여 코드를 작성할 것.

==============================================

- [상수경로]
  - [ENUM/타입]: src/constants/enums.ts "또는 src/types/*"
  - [URL/라우트]: src/constants/routes.ts

==============================================

1. 비즈니스 로직 및 HOOKS 조건

   - **Separation of Concerns:** UI 컴포넌트 내부에는 렌더링 로직만 남기고, 복잡한 비즈니스 로직이나 데이터 가공은 **Custom Hook**(`src/hooks`)으로 분리할 것.
   - **Server Actions:** 데이터 Mutation(생성/수정/삭제) 로직은 Next.js 16의 **Server Actions**를 우선적으로 고려할 것.
   - **State Minimization:** `useState`와 `useEffect` 사용을 최소화하고, 가능한 파생 상태(Derived State)나 React Query 캐시 데이터를 활용할 것.
   - **Type Safety:** 하드코딩된 문자열/숫자 대신 \* [상수경로]에 정의된 [ENUM]이나 `const` 변수를 활용할 것.

2. 페이지 링크(라우팅) 조건

   - **Hardcoding Ban:** `href`나 `router.push`에 문자열 경로를 직접 입력하지 말 것.
   - **Route Constants:** 반드시 \* [상수경로]에 제공된 `routes.ts` 객체를 import하여 사용할 것.
     - 예: `href={ROUTES.ANIME.DETAIL(id)}`

3. 모달(Modal) 조건

   - **Zustand Management:** 모달의 열림/닫힘 상태는 전역 상태 관리(Zustand)를 통해 제어할 것.
   - **Portal:** `react-dom`의 `createPortal` (또는 기설정된 Portal 컴포넌트)을 사용하여 DOM 계층 구조 바깥에서 렌더링할 것.
   - **Backdrop:** 모달 외부 클릭 시 닫힘 처리와 `ESC` 키 이벤트를 처리할 것.

4. 폼(Form) 및 검증 조건

   - **React Hook Form:** 제어 컴포넌트 대신 `react-hook-form`의 `register`를 활용하여 렌더링 최적화를 할 것.
   - **Zod Validation:** 검증 스키마는 `zod`로 작성하고, 폼 로직과 분리하여 관리할 것 (예: `schemas/loginSchema.ts`).
   - **Type Inference:** `z.infer<typeof schema>`를 사용하여 TypeScript 타입을 자동 생성할 것.

5. API 및 데이터 패칭 조건 (TanStack Query)

   - **Custom Hooks:** `useQuery`, `useMutation`을 컴포넌트에서 직접 호출하지 말고, `src/hooks/queries` 폴더 내에 커스텀 훅으로 래핑하여 재사용성을 높일 것.
   - **Query Keys:** 쿼리 키는 `queryKeys.ts`와 같이 한곳에서 상수 팩토리 패턴으로 관리할 것.
   - **Server Integration:** Server Component에서 `prefetchQuery`를 사용한 뒤 HydrationBoundary를 사용하는 패턴을 준수할 것.

6. TEST 조건 (Playwright TDD)
   - **TDD First:** 기능을 구현하기 전에 실패하는 테스트 코드를 먼저 작성할 것.
   - **Config Immutable:** `playwright.config.ts` 설정은 변경하지 말 것.
   - **Execution:** 테스트는 반드시 `package.json` 스크립트를 통해서만 실행할 것.
   - **Real Data (No Mock):** E2E 테스트의 신뢰성을 위해 Mock 데이터를 지양하고, 실제 DB(테스트 환경) 또는 API 응답을 사용할 것.
     - _주의: 쓰기/삭제 테스트 시 테스트 데이터가 격리되도록 유의할 것._
   - **Selectors:** CSS Selector 충돌 방지를 위해 테스트 대상 요소에는 반드시 `data-testid="section-name"` 속성을 부여하고, `page.getByTestId(...)`를 사용할 것.
   - **Wait Mechanism:** `page.waitForTimeout(2000)`과 같은 하드코딩된 대기를 금지한다.
     - 대신 `expect(locator).toBeVisible()` 등의 Smart Assertion이나 `waitForURL`, `waitForResponse`를 사용할 것.
     - 부득이한 경우 Timeout은 2000ms 미만으로 제한한다.
   - **Relative Paths:** `page.goto` 사용 시 `baseUrl`을 제외한 상대 경로(`/login` 등)만 입력할 것.
