---
alwaysApply: true
---

# Testy Project Rules

아래의 조건 및 주의사항을 모두 적용하여 코드를 작성할 것.

## 1. 기술 스택 및 환경 (Tech Stack)

- **Framework:** Next.js 16 (App Router, Turbopack)
- **Core Library:** React 19 (RC/Stable)
- **Language:** TypeScript 5.x (Strict Mode)
- **Styling:** Tailwind CSS 4.x (or latest compatible v3.4+)
- **Backend:** Supabase (Auth, DB)
- **Package Manager:** Yarn (yarn.lock 사용, package-lock.json 금지)
- **State Management (Hybrid Strategy):**
  - **Server State:** TanStack Query v5 (@tanstack/react-query) - API 캐싱, 무한 스크롤
  - **Client UI State:** Zustand v5 - 모달 제어, 전역 UI 설정
- **i18n:** i18next + react-i18next (다국어 지원: ko, en, ja, vi)

## 2. 상태 관리 원칙 (State Management Rules)

**가장 중요한 규칙임.** 데이터의 성격에 따라 도구를 엄격히 구분한다.

- **Server Data (API):**
  - 기본적으로 **Server Components**에서 `fetch`로 데이터를 가져와 렌더링하는 것을 1순위로 한다. (초기 로딩 속도 최적화)
  - 클라이언트 사이드 인터랙션(무한 스크롤, 실시간 필터링, 낙관적 업데이트)이 필요한 경우에만 **TanStack Query** (`useQuery`, `useMutation`)를 사용한다.
  - `useEffect`로 API를 직접 호출하여 상태에 넣는 행위를 금지한다.
- **Client State (UI):**
  - 앱 전역에서 공유되는 UI 상태(로그인 모달 열림 여부, 사이드바 토글 등)는 **Zustand** Store로 관리한다.
  - 단순한 컴포넌트 내부 상태(Form 입력값 등)는 `useState`를 사용한다.

## 3. 코딩 스타일 및 원칙 (Coding Standards)

- **Next.js 16 / React 19 Patterns:**
  - Server Components가 기본이며, `use client` 지시어는 꼭 필요한 경우에만 파일 최상단에 작성한다.
  - 데이터 변형(Form Submit 등)은 **Server Actions**를 우선 고려한다.
  - `async/await`를 사용한 Server Components에서의 데이터 페칭을 권장한다.
- **Styling:**
  - Tailwind Utility Class를 우선 사용한다. (`styles.module.css` 등 별도 파일 생성 금지)
  - 색상은 `bg-zinc-950`, `text-blue-500` 등 지정된 디자인 시스템 토큰을 준수한다.
- **Types:**
  - `any` 타입 사용을 엄격히 금지한다.
  - DB 스키마 타입은 Supabase에서 생성된 타입을 `import`하여 사용한다.

## 4. 폴더 구조 (Directory Structure)

아래 구조를 엄격히 준수한다.

### Next.js 16 App Router + 다국어 구조

```
/
├── app/
│   ├── [locale]/                 # 다국어 라우팅 (ko, en, ja, vi)
│   │   ├── (legal)/              # 약관 등 (Route Group)
│   │   │   ├── privacy/
│   │   │   └── terms/
│   │   ├── admin/                # 관리자 페이지
│   │   ├── auth/                 # 인증 관련
│   │   │   └── callback/
│   │   │       └── route.ts      # 구글 OAuth 콜백 처리
│   │   ├── category/             # 카테고리 페이지
│   │   ├── gallery/              # 갤러리
│   │   ├── mbti/                 # MBTI 테스트
│   │   ├── play/                 # 게임 (draw, ladder, lunch)
│   │   ├── tarot/                # 타로 카드
│   │   ├── test/                 # 테스트 상세 페이지
│   │   ├── layout.tsx            # Locale 레이아웃 (Supabase Auth, i18n)
│   │   ├── page.tsx              # 메인 페이지
│   │   └── not-found.tsx         # 404 페이지 (다국어 지원)
│   ├── globals.css               # 전역 스타일
│   ├── layout.tsx                # Root Layout (html, body, 메타데이터)
│   ├── robots.ts                 # robots.txt 생성
│   └── sitemap.ts                # sitemap.xml 생성 (다국어 URL 포함)
├── components/
│   ├── modal/
│   │   └── auth-modal.tsx        # 인증 모달
│   └── layout/
│       └── Header.tsx            # 헤더 (로그인 버튼 포함)
├── lib/
│   └── supabase/
│       ├── server.ts              # Server Component용 Supabase 클라이언트
│       ├── client.ts              # Client Component용 Supabase 클라이언트
│       └── middleware.ts          # 미들웨어용 Supabase 세션 관리
├── middleware.ts                 # Next.js 미들웨어 (i18n 라우팅 + Supabase Auth)
└── public/
    └── locales/                  # i18next 번역 파일
        ├── ko/
        ├── en/
        ├── ja/
        └── vi/
```

### Next.js 16 + 다국어 + Supabase Auth 필수 설정

1. **`next.config.mjs`**:

```ts
/** @type {import('next').NextConfig} */
const nextConfig = {
  images: {
    remotePatterns: [
      {
        protocol: "https",
        hostname: "lh3.googleusercontent.com", // Google 프로필 이미지
      },
      {
        protocol: "https",
        hostname: "*.supabase.co", // Supabase Storage 이미지
      },
    ],
  },
};

export default nextConfig;
```

2. **`middleware.ts`** (프로젝트 루트에 위치):

```ts
import { NextRequest, NextResponse } from "next/server";
import { updateSession } from "./lib/supabase/middleware";

const locales = ["ko", "en", "ja", "vi"];

export async function middleware(request: NextRequest) {
  const { pathname } = request.nextUrl;

  // 정적 자산 및 SEO 파일 제외
  if (
    /\.[a-zA-Z0-9]+$/.test(pathname) ||
    ["/robots.txt", "/sitemap.xml", "/ads.txt"].includes(pathname)
  ) {
    return NextResponse.next();
  }

  // API 경로는 Supabase 세션만 업데이트
  if (pathname.startsWith("/api")) {
    return await updateSession(request);
  }

  // 이미 locale이 붙은 경로면 세션만 업데이트
  if (
    locales.some(
      (locale) =>
        pathname.startsWith(`/${locale}/`) || pathname === `/${locale}`
    )
  ) {
    return await updateSession(request);
  }

  // locale 없을 경우 브라우저 언어 감지 후 리디렉션
  const locale = detectLocale(request);
  request.nextUrl.pathname = `/${locale}${pathname}`;
  return NextResponse.redirect(request.nextUrl);
}

export const config = {
  matcher: [
    "/((?!_next/|favicon.ico|robots.txt|ads\\.txt|sitemap\\.xml|api).*)",
  ],
};
```

3. **`app/layout.tsx`** (루트 레이아웃):

```ts
import type { Metadata } from "next";
import "./globals.css";

// ⚠️ Next.js 16: generateMetadata는 async 필수
export async function generateMetadata({
  params,
}: {
  params: Promise<{ locale: string }>;
}): Promise<Metadata> {
  const { locale } = await params; // ⚠️ 필수: await 사용

  return {
    title: "Testy",
    metadataBase: new URL("https://testy.im"),
    alternates: {
      languages: {
        "ko-KR": "https://testy.im/ko",
        "en-US": "https://testy.im/en",
        "ja-JP": "https://testy.im/ja",
        "vi-VN": "https://testy.im/vi",
      },
    },
  };
}

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html>
      <body>{children}</body>
    </html>
  );
}
```

4. **`app/[locale]/layout.tsx`** (Locale 레이아웃):

```ts
import type { Metadata } from "next";
import { createClientForServer } from "@/lib/supabase/server";

// ⚠️ 필수: async 함수로 export
export async function generateStaticParams() {
  return [
    { locale: "ko" },
    { locale: "en" },
    { locale: "ja" },
    { locale: "vi" },
  ];
}

// ⚠️ Next.js 16: generateMetadata는 async 필수, params는 Promise
export async function generateMetadata({
  params,
}: {
  params: Promise<{ locale: string }>;
}): Promise<Metadata> {
  const { locale } = await params; // ⚠️ 필수: await 사용

  return {
    title: `Testy - ${locale}`,
    description: "...",
    openGraph: {
      locale: locale,
      // ...
    },
    alternates: {
      canonical: `https://testy.im/${locale}`,
    },
  };
}

export default async function LocaleLayout({
  children,
  params,
}: {
  children: React.ReactNode;
  params: Promise<{ locale: string }>; // ⚠️ Next.js 16: params는 Promise 타입
}) {
  const { locale } = await params; // ⚠️ 필수: await 사용

  // Supabase Auth: 서버에서 사용자 정보 가져오기
  const supabase = await createClientForServer();
  const {
    data: { user },
  } = await supabase.auth.getUser();

  return (
    <div lang={locale}>
      {/* 사용자 정보를 Client Component로 전달 */}
      <ClientLayout user={user} locale={locale}>
        {children}
      </ClientLayout>
    </div>
  );
}
```

5. **`app/[locale]/auth/callback/route.ts`** (구글 OAuth 콜백):

```ts
import { createClientForServer } from "@/lib/supabase/server";
import { NextRequest, NextResponse } from "next/server";

export async function GET(
  request: NextRequest,
  { params }: { params: Promise<{ locale: string }> }
) {
  const { locale } = await params; // ⚠️ Next.js 16: await 필수
  const { searchParams, origin } = new URL(request.url);
  const code = searchParams.get("code");

  if (code) {
    const supabase = await createClientForServer();
    const { error } = await supabase.auth.exchangeCodeForSession(code);

    if (!error) {
      return NextResponse.redirect(`${origin}/${locale}`);
    }
  }

  return NextResponse.redirect(`${origin}/${locale}/auth/error`);
}
```

6. **`app/sitemap.ts`** (SEO: 다국어 사이트맵):

```ts
import { MetadataRoute } from "next";

export default async function sitemap(): Promise<MetadataRoute.Sitemap> {
  const baseUrl = "https://testy.im";
  const locales = ["ko", "en", "ja", "vi"] as const;

  // 정적 URL
  const staticUrls = locales.flatMap((locale) => [
    { url: `${baseUrl}/${locale}`, lastModified: new Date() },
    // ...
  ]);

  // 동적 URL (DB에서 가져오기)
  const dynamicUrls = (await Promise.all(
    locales.map(async (locale) => {
      // 데이터 페칭...
      return [...];
    })
  )).flat();

  return [...staticUrls, ...dynamicUrls];
}
```

7. **`app/robots.ts`** (SEO: robots.txt):

```ts
import { MetadataRoute } from "next";

export default function robots(): MetadataRoute.Robots {
  return {
    rules: [{ userAgent: "*", allow: "/", disallow: ["/admin", "/api"] }],
    sitemap: "https://testy.im/sitemap.xml",
  };
}
```

8. **SEO 최적화 필수 사항**:

   - ⚠️ 모든 페이지에 `generateMetadata` 함수 구현 (async 필수)
   - ⚠️ `alternates.languages`로 다국어 hreflang 태그 자동 생성
   - ⚠️ `alternates.canonical`로 정규 URL 지정
   - ⚠️ Open Graph 이미지는 1200x630px 권장
   - ⚠️ `sitemap.ts`에서 정적/동적 URL 모두 포함
   - ⚠️ `robots.ts`에서 관리자 페이지 제외 설정

9. **Supabase Auth + 구글 OAuth 통합**:

   - ⚠️ 서버: `createClientForServer()` 사용 (쿠키 기반 세션)
   - ⚠️ 클라이언트: `createClient()` 사용 (브라우저 클라이언트)
   - ⚠️ 미들웨어: `updateSession()`으로 모든 요청에서 세션 갱신
   - ⚠️ OAuth 리디렉션: `redirectTo`에 `/${locale}/auth/callback` 지정
   - ⚠️ 콜백 처리: `exchangeCodeForSession()`으로 코드 교환

10. **중요 주의사항**:

- ⚠️ Next.js 16에서 `params`, `searchParams`는 모두 `Promise` 타입이므로 `await` 필수
- ⚠️ `generateMetadata`와 `generateStaticParams`는 반드시 `async` 함수
- ⚠️ 루트 레이아웃(`app/layout.tsx`)과 Locale 레이아웃(`app/[locale]/layout.tsx`) 분리
- ⚠️ Supabase Auth는 서버에서 `createClientForServer()`로 처리
- ⚠️ 구글 OAuth 콜백은 `app/[locale]/auth/callback/route.ts`에 위치
- ⚠️ 다국어 URL은 `alternates.languages`로 hreflang 태그 자동 생성
- ⚠️ 미들웨어에서 SEO 파일(`robots.txt`, `sitemap.xml`) 제외 필수

## 5. GIT 컨벤션 (Conventional Commits)

작업 완료 후 커밋 메시지는 **한국어**로 작성한다.

- `feat`: 새로운 기능 추가 (예: `feat: 주스탠드 스토어 초기 설정`)
- `fix`: 버그 수정 (예: `fix: 무한 스크롤 중복 요청 수정`)
- `docs`: 문서 수정 (예: `docs: README 설치 가이드 추가`)
- `style`: 코드 포맷팅 (예: `style: Tailwind 클래스 정렬`)
- `refactor`: 코드 리팩토링 (예: `refactor: 애니메이션 카드 컴포넌트 분리`)
- `chore`: 설정 파일 수정, 패키지 업데이트 (예: `chore: next-intl 업데이트`)

## 6. 작업 프로세스 (Workflow)

AI는 작업을 시작하기 전에 다음 단계를 수행해야 한다.

1. **분석 (Analyze):** `package.json`을 확인하여 Next.js 16 및 관련 라이브러리 버전을 파악한다.
2. **계획 (Plan):** 구현할 기능의 단계를 step-by-step으로 정리한다.
3. **구현 (Implement):** 계획에 따라 코드를 작성한다.
   - Server Component 우선 원칙 준수
   - Client Component는 최소화 (`use client`는 필요한 곳에만)
   - Server Actions를 통한 데이터 변형
4. **검토 (Review):**
   - 상태 관리 도구(Zustand vs TanStack Query)가 적절히 사용되었는지 확인
   - Server/Client Component 분리가 적절한지 확인
   - TypeScript 타입 안정성 확인 (`any` 금지)
5. **확인 (Verify):**
   - `yarn build`를 통해 빌드 오류가 없는지 확인
   - `yarn lint`로 코드 품질 검증

### 패키지 매니저 규칙 (Package Manager Rules)

- **Yarn 전용:** 이 프로젝트는 **Yarn**만 사용한다.
  - 패키지 설치: `yarn add <package>` 또는 `yarn add -D <package>`
  - 패키지 제거: `yarn remove <package>`
  - 의존성 업데이트: `yarn upgrade` 또는 `yarn upgrade <package>`
  - **금지:** `npm install`, `npm install -g`, `npx` 등의 npm 명령어 사용 금지
  - **금지:** `package-lock.json` 파일 생성 금지 (`.gitignore`에 포함됨)
  - **필수:** `yarn.lock` 파일만 사용하고 커밋에 포함

## 7. 주요 패턴 예시

### Server Component (기본) - Next.js 16

```tsx
// app/[locale]/test/[id]/page.tsx
import { getTestById } from "@/lib/supabase/test/getTestById";

// ⚠️ Next.js 16: params는 Promise 타입
export default async function TestPage({
  params,
}: {
  params: Promise<{ id: string; locale: string }>;
}) {
  const { id, locale } = await params; // ⚠️ 필수: await 사용
  const test = await getTestById(id, locale);

  return <TestDetail test={test} locale={locale} />;
}
```

### Server Component with Metadata (SEO 최적화)

```tsx
// app/[locale]/test/[id]/page.tsx
import type { Metadata } from "next";

// ⚠️ Next.js 16: generateMetadata는 async 필수
export async function generateMetadata({
  params,
}: {
  params: Promise<{ id: string; locale: string }>;
}): Promise<Metadata> {
  const { id, locale } = await params;
  const test = await getTestById(id, locale);

  return {
    title: test.title,
    description: test.description,
    openGraph: {
      title: test.title,
      description: test.description,
      images: [test.thumbnail_url],
      locale: locale,
    },
    alternates: {
      canonical: `https://testy.im/${locale}/test/${id}`,
      languages: {
        "ko-KR": `https://testy.im/ko/test/${id}`,
        "en-US": `https://testy.im/en/test/${id}`,
        "ja-JP": `https://testy.im/ja/test/${id}`,
      },
    },
  };
}
```

### Client Component (인터랙션 필요시)

```tsx
// components/test/TestView.tsx
"use client";

import { useInfiniteQuery } from "@tanstack/react-query";
import { useTranslations } from "react-i18next";

export function TestList({ locale }: { locale: string }) {
  const { t } = useTranslations("common");

  const { data, fetchNextPage } = useInfiniteQuery({
    queryKey: ["tests", locale],
    queryFn: ({ pageParam }) => fetchTests({ locale, page: pageParam }),
  });

  return (
    <div>
      <h1>{t("test_list_title")}</h1>
      {/* ... */}
    </div>
  );
}
```

### Supabase Auth (서버)

```tsx
// app/[locale]/layout.tsx
import { createClientForServer } from "@/lib/supabase/server";

export default async function LocaleLayout({
  children,
  params,
}: {
  children: React.ReactNode;
  params: Promise<{ locale: string }>;
}) {
  const { locale } = await params;

  // 서버에서 사용자 정보 가져오기
  const supabase = await createClientForServer();
  const {
    data: { user },
  } = await supabase.auth.getUser();

  return (
    <ClientLayout user={user} locale={locale}>
      {children}
    </ClientLayout>
  );
}
```

### Supabase Auth (클라이언트)

```tsx
// components/modal/auth-modal.tsx
"use client";

import { createClient } from "@/lib/supabase/client";

export function GoogleSignInButton() {
  const supabase = createClient();

  const handleSignIn = async () => {
    const { error } = await supabase.auth.signInWithOAuth({
      provider: "google",
      options: {
        redirectTo: `${window.location.origin}/${locale}/auth/callback`,
      },
    });

    if (error) console.error(error);
  };

  return <button onClick={handleSignIn}>구글로 로그인</button>;
}
```

### Zustand Store (UI 상태)

```tsx
// store/useAuthStore.ts
import { create } from "zustand";

interface AuthState {
  isModalOpen: boolean;
  openModal: () => void;
  closeModal: () => void;
}

export const useAuthStore = create<AuthState>((set) => ({
  isModalOpen: false,
  openModal: () => set({ isModalOpen: true }),
  closeModal: () => set({ isModalOpen: false }),
}));
```

### Server Action (데이터 변형)

```tsx
// lib/supabase/action.ts
"use server";

import { createClientForServer } from "@/lib/supabase/server";
import { revalidatePath } from "next/cache";

export async function saveTestResult(
  testId: string,
  result: TestResult,
  locale: string
) {
  const supabase = await createClientForServer();
  const { data, error } = await supabase
    .from("test_results")
    .insert({ test_id: testId, result });

  if (error) throw error;

  // 캐시 무효화
  revalidatePath(`/${locale}/test/${testId}`);

  return data;
}
```
